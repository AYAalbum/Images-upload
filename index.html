<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYA Media Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=Crete+Round&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --forest: #003366; /* AYA Blue */
            --accent: #CC0000; /* AYA Red */
            --success: #27ae60; /* Pro Green */
            --bg: #F4F1EA;
            --card-bg: rgba(255, 255, 255, 0.92); /* Glassy White */
            --text: #333333;
            --border: #e0e0e0;
            --input-bg: #f8f9fa;
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        [data-theme="dark"] {
            --forest: #4da6ff;
            --accent: #ff4d4d;
            --success: #2ecc71;
            --bg: #121212;
            --card-bg: rgba(30, 30, 30, 0.92);
            --text: #e0e0e0;
            --border: #444;
            --input-bg: #2d2d2d;
            --shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- LAYOUT --- */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            backdrop-filter: blur(10px); /* Glassmorphism */
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            border-radius: 12px;
            overflow: hidden;
            border-top: 6px solid var(--forest);
            transition: all 0.3s;
            position: relative;
            z-index: 10;
        }

        header {
            background: var(--forest);
            color: white;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-wrapper { display: flex; align-items: center; gap: 15px; }
        .header-logo { height: 45px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        h1 { margin: 0; font-family: 'Crete Round', serif; letter-spacing: 1px; font-size: 1.5rem; }
        
        @media (max-width: 600px) {
            h1 { font-size: 1.1rem; } 
            .header-logo { height: 35px; }
            .form-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
            header { padding: 1rem; }
        }

        /* --- FORM ELEMENTS --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 2rem;
        }

        label { display: block; font-weight: bold; color: var(--forest); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .helper-text { font-size: 0.7rem; color: #888; margin-top: -6px; margin-bottom: 8px; font-style: italic; }
        
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: var(--input-bg); 
            color: var(--text); 
            margin-bottom: 20px; 
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--forest); outline: none; }

        /* TABS */
        .mode-toggle { display: flex; background: var(--border); border-radius: 8px; padding: 4px; margin-bottom: 20px; grid-column: 1 / -1; }
        .mode-option { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.9rem; color: #888; border-radius: 6px; transition: 0.2s; }
        .mode-option.active { background: var(--card-bg); color: var(--forest); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* --- UPLOAD AREA --- */
        .upload-area { padding: 0 2rem 2rem 2rem; }
        
        .btn-select { 
            background: var(--input-bg); 
            border: 2px dashed var(--forest); 
            color: var(--forest); 
            padding: 2rem; 
            text-align: center;
            cursor: pointer; 
            border-radius: 12px; 
            font-weight: bold; 
            font-size: 1.1rem;
            transition: all 0.2s; 
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .btn-select:hover { background: rgba(0,0,0,0.03); transform: translateY(-2px); }

        /* --- POLAROID GALLERY --- */
        #gallery { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 30px; }
        
        .polaroid { 
            background: white; 
            padding: 8px 8px 30px 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
            width: 90px; height: 90px; 
            transform: rotate(-2deg); 
            position: relative; 
            border-radius: 4px;
            transition: transform 0.2s;
        }
        .polaroid:hover { transform: scale(1.05) rotate(0deg); z-index: 5; }
        .polaroid:nth-child(even) { transform: rotate(2deg); }
        
        .polaroid img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; }

        /* STATUS ICONS (SVG) */
        .status-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
        .polaroid.success .status-overlay { display: flex; background: rgba(255,255,255,0.6); }
        .polaroid.success { border: 3px solid var(--success); }
        
        .polaroid.error .status-overlay { display: flex; background: rgba(255,200,200,0.9); }
        .polaroid.error { border: 3px solid var(--accent); }

        /* SVG Icons */
        .icon-svg { width: 40px; height: 40px; }

        /* --- ACTION BAR & PROGRESS --- */
        .action-bar { padding: 2rem; background: var(--input-bg); border-top: 1px solid var(--border); text-align: center; }
        
        .btn-upload { 
            background: linear-gradient(135deg, var(--accent), #a30000); 
            color: white; 
            padding: 14px 50px; 
            border: none; border-radius: 50px; 
            font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(204, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-upload:active { transform: scale(0.98); }
        .btn-upload:disabled { background: #bbb; cursor: not-allowed; box-shadow: none; }

        /* Progress Bar */
        .progress-container {
            width: 100%; max-width: 400px; height: 8px; background: #e0e0e0; border-radius: 4px;
            margin: 15px auto 5px auto; overflow: hidden; display: none;
        }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        #progress-text { font-size: 0.9rem; color: #666; font-weight: bold; }

        /* DRIVE BUTTON */
        .drive-box { 
            background: rgba(0, 51, 102, 0.05); border: 1px solid var(--border); 
            padding: 15px; border-radius: 10px; margin-top: 10px; 
        }
        .btn-drive { 
            background: var(--forest); color: white; padding: 12px; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; 
        }
        #drive-link-container { display: none; margin-top: 10px; }
        .success-link { display: block; background: var(--success); color: white; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center;}

    </style>
</head>
<body>

<div class="main-container">
    <header>
        <div class="title-wrapper">
            <img src="./AYA logo vahanig.png" alt="AYA Logo" class="header-logo">
            <h1>AYA Media Drop</h1>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
    </header>

    <div class="form-grid">
        <div>
            <div class="mode-toggle">
                <div class="mode-option active" id="tab-new" onclick="setMode('new')">Create Folder</div>
                <div class="mode-option" id="tab-existing" onclick="setMode('existing')">Existing Folder</div>
            </div>
            <div id="new-folder-group">
                <label>Folder Name</label>
                <input type="text" id="folderNameInput" placeholder="e.g. Hiking Trip">
                <label>Date</label>
                <input type="date" id="folderDateInput">
            </div>
            <div id="existing-folder-group" style="display:none;">
                <label>Select Folder</label>
                <select id="existingFolderSelect"><option disabled selected>Loading folders...</option></select>
            </div>
        </div>
        
        <div>
            <label>Scout Name</label>
            <div class="helper-text">Who is uploading?</div>
            <input type="text" id="uploaderName" placeholder="Your Name">
            
            <label>Password üîí</label>
            <input type="password" id="campPassword" placeholder="Enter Code">
            
            <div class="drive-box">
                <button class="btn-drive" id="verifyBtn" onclick="verifyAndShowLink()">üìÇ Access Gallery</button>
                <div id="drive-link-container">
                    <a href="#" id="finalDriveLink" target="_blank" class="success-link">‚úÖ Open Drive Folder</a>
                </div>
            </div>
        </div>
    </div>

    <div class="upload-area">
        <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display:none">
        
        <div class="btn-select" onclick="document.getElementById('fileInput').click()">
            <span style="font-size: 2rem">üì∏</span>
            <span>Tap to Select Photos & Videos</span>
        </div>

        <div id="gallery"></div>
    </div>

    <div class="action-bar">
        <button id="uploadBtn" class="btn-upload" onclick="startBatchUpload()">Start Upload</button>
        
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="progress-text"></div>
    </div>
</div>

<script>
    // -----------------------------------------------------------
    // üî¥ PASTE YOUR WEB APP URL HERE
    // -----------------------------------------------------------
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx4zfa2oAJB_tJQ6HjJrsmZ9DtHPZyDl-RwItLDfJLjPeYvsPdrfDki-HNRYRrHveE8Yw/exec"; 

    // CONFIG
    const CONCURRENT_UPLOADS = 3; 
    const MAX_SIZE_MB = 30; // Limit for standard script

    // SVG ICONS (Green Tick & Red X)
    const ICON_SUCCESS = `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="#27ae60" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="#27ae60" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const ICON_ERROR = `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="#CC0000" stroke-width="3"/><path d="M15 9L9 15" stroke="#CC0000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="#CC0000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const ICON_LOADER = `<div style="font-size:1.5rem; animation:spin 1s linear infinite">‚è≥</div>`;

    let currentMode = 'new';
    let fileQueue = [];

    // Theme Logic
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.setAttribute('data-theme', 'dark');
    function toggleTheme() { document.body.getAttribute('data-theme') === 'dark' ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark'); }

    // Init
    window.onload = function() {
        loadFolders();
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('folderDateInput').valueAsDate = new Date();
    };

    function setMode(mode) {
        currentMode = mode;
        const newGroup = document.getElementById('new-folder-group');
        const existGroup = document.getElementById('existing-folder-group');
        if (mode === 'new') {
            newGroup.style.display = 'block'; existGroup.style.display = 'none';
            document.getElementById('tab-new').classList.add('active');
            document.getElementById('tab-existing').classList.remove('active');
        } else {
            newGroup.style.display = 'none'; existGroup.style.display = 'block';
            document.getElementById('tab-new').classList.remove('active');
            document.getElementById('tab-existing').classList.add('active');
        }
    }

    // --- MOBILE FIX: VERIFY THEN SHOW LINK ---
    function verifyAndShowLink() {
        const password = document.getElementById('campPassword').value;
        const btn = document.getElementById('verifyBtn');
        const linkContainer = document.getElementById('drive-link-container');
        
        if (!password) { alert("üîí Please enter the Password first."); return; }

        btn.textContent = "Verifying...";
        btn.disabled = true;
        linkContainer.style.display = 'none';

        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getDriveLink", password: password }),
            headers: { "Content-Type": "text/plain" }
        })
        .then(r => r.json())
        .then(data => {
            if(data.result === 'success') {
                document.getElementById('finalDriveLink').href = data.url;
                linkContainer.style.display = 'block';
                btn.textContent = "Verified!";
                btn.style.background = "#27ae60"; // Green on success
            } else {
                alert(data.error);
                btn.textContent = "üìÇ Access Gallery";
                btn.disabled = false;
            }
        })
        .catch(e => {
            alert("Connection Error");
            btn.textContent = "üìÇ Access Gallery";
            btn.disabled = false;
        });
    }

    document.getElementById('fileInput').addEventListener('change', function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;
        fileQueue = fileQueue.concat(files);
        renderGallery();
    });

    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        
        fileQueue.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'polaroid';
            div.id = 'thumb-' + index;
            
            // Status Overlay (Loader/Success/Error)
            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'status-overlay';
            statusOverlay.id = 'status-' + index;
            div.appendChild(statusOverlay);

            if(file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                div.appendChild(img);
            } else {
                div.innerHTML += "<div style='display:flex;align-items:center;justify-content:center;height:100%;font-size:2rem'>üé¨</div>";
            }
            gallery.appendChild(div);
        });
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('progress-text').textContent = `${fileQueue.length} media ready.`;
    }

    // --- UPLOAD LOGIC ---
    async function startBatchUpload() {
        const password = document.getElementById('campPassword').value;
        const uploader = document.getElementById('uploaderName').value || "Anonymous";
        let folderName = "";

        if (!password) { alert("‚ö†Ô∏è Please enter the Password!"); return; }

        if (currentMode === 'new') {
            const name = document.getElementById('folderNameInput').value;
            const date = document.getElementById('folderDateInput').value;
            if(!name || !date) { alert("Please enter Folder Name AND Date"); return; }
            const [y, m, d] = date.split('-');
            folderName = `${name} - ${d}/${m}/${y}`;
        } else {
            folderName = document.getElementById('existingFolderSelect').value;
            if(!folderName) { alert("Please select a folder!"); return; }
        }

        // Setup UI
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('progress-container').style.display = 'block';
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('progress-text');
        
        // Parallel Logic
        let activeUploads = 0;
        let completed = 0;
        let nextIndex = 0;

        const uploadLoop = () => {
            return new Promise((resolve) => {
                if (nextIndex >= fileQueue.length) { resolve(); return; }

                const index = nextIndex++;
                const file = fileQueue[index];
                
                // SIZE CHECK (Prevent Red X on big files)
                if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                    markError(index);
                    completed++;
                    updateProgress(completed);
                    uploadLoop().then(resolve);
                    return;
                }

                // Show loader
                const overlay = document.getElementById('status-' + index);
                overlay.style.display = 'flex';
                overlay.innerHTML = ICON_LOADER;
                statusText.textContent = `Uploading ${file.name}...`;

                // Read file
                const reader = new FileReader();
                reader.onload = function(e) {
                    const rawBase64 = e.target.result.split(',')[1];
                    
                    fetch(WEB_APP_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            action: "upload",
                            password: password,
                            folderType: currentMode,
                            folderName: folderName,
                            selectedFolder: folderName,
                            uploaderName: uploader,
                            file: rawBase64,
                            mimeType: file.type,
                            filename: file.name
                        }),
                        headers: { "Content-Type": "text/plain" }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.result === 'success') {
                           markSuccess(index);
                        } else {
                           markError(index);
                           console.error(data.error);
                        }
                    })
                    .catch(err => {
                        markError(index);
                        console.error(err);
                    })
                    .finally(() => {
                        completed++;
                        updateProgress(completed);
                        uploadLoop().then(resolve);
                    });
                };
                reader.readAsDataURL(file);
            });
        };

        // Start Concurrent Threads
        const threads = [];
        for (let i = 0; i < CONCURRENT_UPLOADS; i++) {
            threads.push(uploadLoop());
        }

        await Promise.all(threads);
        
        statusText.textContent = "üéâ All Done!";
        progressBar.style.width = "100%";
        fileQueue = [];
        loadFolders();
    }

    function updateProgress(completed) {
        const percent = (completed / fileQueue.length) * 100;
        document.getElementById('progress-bar').style.width = percent + "%";
        document.getElementById('progress-text').textContent = `Processed ${completed} of ${fileQueue.length}`;
    }

    function markSuccess(index) {
        const overlay = document.getElementById('status-' + index);
        overlay.innerHTML = ICON_SUCCESS;
        document.getElementById('thumb-' + index).classList.add('success');
    }

    function markError(index) {
        const overlay = document.getElementById('status-' + index);
        overlay.innerHTML = ICON_ERROR;
        document.getElementById('thumb-' + index).classList.add('error');
    }

    function loadFolders() {
        const select = document.getElementById('existingFolderSelect');
        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getFolders" }),
            headers: { "Content-Type": "text/plain" }
        })
        .then(r => r.json())
        .then(data => {
            if (data.result === 'success') {
                select.innerHTML = '<option value="" disabled selected>Select Folder...</option>';
                data.folders.forEach(f => {
                    let opt = document.createElement("option");
                    opt.text = f; opt.value = f; select.add(opt);
                });
            }
        }).catch(e => console.log(e));
    }
</script>

</body>
</html>
